# è„±æœºç¼–è¯‘æµ‹è¯• Makefile
# ç”¨äºåœ¨æ²¡æœ‰ç¡¬ä»¶è¿æ¥çš„æƒ…å†µä¸‹è¿›è¡Œç¼–è¯‘æµ‹è¯•

# å·¥å…·é“¾é…ç½®
CC = arm-none-eabi-gcc
OBJCOPY = arm-none-eabi-objcopy
SIZE = arm-none-eabi-size

# ç¼–è¯‘é€‰é¡¹
CPU = -mcpu=cortex-m0plus
MTHUMB = -mthumb
MFLOAT = -mfloat-abi=soft

CFLAGS = $(CPU) $(MTHUMB) $(MFLOAT)
CFLAGS += -Wall -Wextra -std=c99
CFLAGS += -fdata-sections -ffunction-sections
CFLAGS += -nostdlib -fno-builtin
CFLAGS += -g -O0  # Debugæ¨¡å¼

# åŒ…å«è·¯å¾„
INCLUDES = -Isrc/include -Iapp/ota/include

# æºæ–‡ä»¶
SOURCES = src/main_loop.c \
          src/Modbus.c \
          src/io.c \
          src/sys_flash.c \
          src/RI300CRC.c \
          src/datastruct.c \
          src/alarm.C \
          src/Base_Para.C

# æµ‹è¯•ç›®æ ‡
OBJECTS = $(SOURCES:.c=.o)
TARGET = build/test/hy-cool-dtu-test

# åˆ›å»ºç›®å½•
$(shell mkdir -p build/test build/logs)

.PHONY: all clean syntax-check cmake-test test-all help

# é»˜è®¤ç›®æ ‡
all: help

# æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "=== hy-cool-dtu è„±æœºç¼–è¯‘æµ‹è¯• ==="
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  syntax-check  - è¿›è¡ŒCä»£ç è¯­æ³•æ£€æŸ¥"
	@echo "  cmake-test    - æµ‹è¯•CMakeæ„å»º"
	@echo "  test-all      - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  clean         - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make -f Makefile.test syntax-check"
	@echo "  make -f Makefile.test test-all"

# è¯­æ³•æ£€æŸ¥
syntax-check:
	@echo "=== Cä»£ç è¯­æ³•æ£€æŸ¥ ==="
	@echo "æ£€æŸ¥ç¼–è¯‘å·¥å…·é“¾..."
	@if ! which $(CC) > /dev/null 2>&1; then \
		echo "âŒ ARM GCC æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: brew install --cask gcc-arm-embedded"; \
		exit 1; \
	fi
	@echo "âœ… ARM GCC: $$($(CC) --version | head -n1)"
	@echo ""
	@echo "å¼€å§‹è¯­æ³•æ£€æŸ¥..."
	@error_count=0; \
	for file in $(SOURCES); do \
		if [ -f "$$file" ]; then \
			echo "æ£€æŸ¥: $$file"; \
			if $(CC) $(CFLAGS) $(INCLUDES) -fsyntax-only "$$file" 2>build/logs/syntax_$$(date +%s).log; then \
				echo "  âœ… è¯­æ³•æ­£ç¡®"; \
			else \
				echo "  âŒ æœ‰è¯­æ³•é”™è¯¯"; \
				error_count=$$((error_count + 1)); \
				tail -n 3 build/logs/syntax_$$(date +%s).log | sed 's/^/    /'; \
			fi; \
		else \
			echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $$file"; \
		fi; \
	done; \
	echo ""; \
	if [ $$error_count -eq 0 ]; then \
		echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼"; \
	else \
		echo "âŒ $$error_count ä¸ªæ–‡ä»¶æœ‰è¯­æ³•é”™è¯¯"; \
		exit 1; \
	fi

# CMakeæµ‹è¯•
cmake-test:
	@echo "=== CMakeç¼–è¯‘æµ‹è¯• ==="
	@if [ ! -f "CMakeLists.txt" ]; then \
		echo "âŒ CMakeLists.txt ä¸å­˜åœ¨"; \
		exit 1; \
	fi
	@if [ ! -f "cmake/arm-none-eabi.cmake" ]; then \
		echo "âŒ ARMå·¥å…·é“¾æ–‡ä»¶ä¸å­˜åœ¨"; \
		exit 1; \
	fi
	@echo "å‡†å¤‡æ„å»ºç›®å½•..."
	@rm -rf build/test_cmake
	@mkdir -p build/test_cmake
	@echo "é…ç½®CMakeé¡¹ç›®..."
	@cd build/test_cmake && \
	if cmake -DCMAKE_TOOLCHAIN_FILE=../../cmake/arm-none-eabi.cmake -DCMAKE_BUILD_TYPE=Debug ../..; then \
		echo "âœ… CMakeé…ç½®æˆåŠŸ"; \
		echo "å¼€å§‹ç¼–è¯‘..."; \
		if make -j4; then \
			echo "ğŸ‰ CMakeç¼–è¯‘æˆåŠŸï¼"; \
			if [ -f "hy-cool-dtu.elf" ]; then \
				echo "âœ… ç¼–è¯‘äº§ç‰©:"; \
				ls -la hy-cool-dtu.*; \
				if which $(SIZE) > /dev/null 2>&1; then \
					echo "ğŸ“Š å›ºä»¶å¤§å°:"; \
					$(SIZE) hy-cool-dtu.elf; \
				fi; \
			fi; \
		else \
			echo "âŒ CMakeç¼–è¯‘å¤±è´¥"; \
			exit 1; \
		fi; \
	else \
		echo "âŒ CMakeé…ç½®å¤±è´¥"; \
		exit 1; \
	fi

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test-all: 
	@echo "ğŸš€ å¼€å§‹å®Œæ•´çš„è„±æœºç¼–è¯‘æµ‹è¯•"
	@echo "æ—¶é—´: $$(date)"
	@echo "é¡¹ç›®è·¯å¾„: $$(pwd)"
	@echo ""
	@$(MAKE) -f Makefile.test syntax-check
	@echo ""
	@$(MAKE) -f Makefile.test cmake-test
	@echo ""
	@echo "=== æµ‹è¯•æ€»ç»“ ==="
	@echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è„±æœºå¼€å‘ç¯å¢ƒæ­£å¸¸ï¼"
	@echo "âœ… æ‚¨å¯ä»¥ç»§ç»­è¿›è¡Œè„±æœºå¼€å‘"
	@echo "ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®:"
	@echo "   1. ç¼–è¾‘ src/ ç›®å½•ä¸‹çš„æºæ–‡ä»¶"
	@echo "   2. å®šæœŸè¿è¡Œæµ‹è¯•éªŒè¯ä»£ç å˜æ›´"
	@echo "   3. è¿æ¥ç¡¬ä»¶åä½¿ç”¨ ./flash.sh çƒ§å½•"

# æ¸…ç†
clean:
	@echo "æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf build/test build/test_cmake build/logs/*.log
	@echo "âœ… æ¸…ç†å®Œæˆ"

# åˆ›å»ºæµ‹è¯•æŠ¥å‘Š
report:
	@echo "# hy-cool-dtu è„±æœºæµ‹è¯•æŠ¥å‘Š" > build/test_report.md
	@echo "" >> build/test_report.md
	@echo "- **æµ‹è¯•æ—¶é—´**: $$(date)" >> build/test_report.md
	@echo "- **é¡¹ç›®è·¯å¾„**: $$(pwd)" >> build/test_report.md
	@echo "- **ARM GCC**: $$($(CC) --version | head -n1 2>/dev/null || echo 'æœªå®‰è£…')" >> build/test_report.md
	@echo "- **CMake**: $$(cmake --version | head -n1 2>/dev/null || echo 'æœªå®‰è£…')" >> build/test_report.md
	@echo "" >> build/test_report.md
	@echo "æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: build/test_report.md" 